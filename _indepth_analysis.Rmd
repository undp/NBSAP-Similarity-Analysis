---
params:
  country: Uzbekistan
  date: 17Apr24
  nbsap: TRUE
output: 
  officedown::rdocx_document:
    reference_docx: template.docx
    plots:
      style: Normal
      align: center
      topcaption: true
header-includes:
  - \usepackage{floatrow}
  - \floatsetup[figure]{capposition=top}
---

```{r setupPackages, include=FALSE}
# moves away from scientific notation (e-17)
options(scipen = 999)

# mounts packages
pacman::p_load("tidyverse", "knitr", "stringr", "readr", "openxlsx", "writexl", "readxl", 
               "ggplot2", "ggpattern", "ggnewscale", "ggpubr", "geomtextpath", "ggbeeswarm", 
               "officedown", "officer", "flextable", "kableExtra",
               "magrittr", "captioner", "rvest", 
               "countries")
```

```{r setupScript, include=FALSE}
# Officedown/Markdown configurations
opts_chunk$set(echo = FALSE, 
               fig.cap = TRUE, tab.cap = TRUE)

set_flextable_defaults(font.family = "Calibri", hansi.family = "Calibri", font.size = 9)

bl_template <- function(txt) {
  block_list(
    fpar(values = txt, fp_t = fp_text_lite(color = "#0001a4", bold = TRUE))
  )
}
sec_port <- prop_section()

sec_land <- prop_section(page_size = page_size(orient = "landscape"), 
    type = "continuous", page_margins = page_mar(top = 0, right = 0, bottom = 0, left = 0))

sec_toc <- prop_section(type = "continuous", page_margins = page_mar(bottom = 0))

links <- fp_text(color = "#0563C1", underlined = TRUE, font.size = 12, font.family = "Calibri")
links_i <- fp_text(color = "#0563C1", underlined = TRUE, font.size = 9, italic = TRUE, font.family = "Calibri")
footnote <- fp_text(italic = TRUE, font.size = 9, font.family = "Calibri")
section <- fp_text(font.size = 16, bold = TRUE, font.family = "Calibri")
subsection <- fp_text(font.size = 14, bold = TRUE, font.family = "Calibri")
caption1 <- fp_text(font.size = 11, font.family = "Calibri")
caption2 <- fp_text(font.size = 11, font.family = "Calibri", bold = TRUE)
```

\pagenumbering{gobble}

```{r dataImport, include = FALSE}
# ensures that composite country names are separated by "_"; adapts for special cases (conditinoal)
if (params$country == "Kazakhstan") { 
  cfill <- paste0(params$country, "ZEP") # C30, N99
} else {
  cfill <- str_replace_all(params$country, " ", "_")
}

# sets path and file name (conditional)
if (params$nbsap == TRUE) { 
  path <- "../data/similarity_results/"
} else {
  path <- "../data/similarity_results/non-nbts/"
}

# Uploading the data
dta <- read.csv(paste0(path, "UNDP_LLM_Assessment_", cfill, "_enterprise_", params$date, ".csv"))

# ISO2 codes (to reach the country's page on the CBD NBT website)
iso2 <- tolower(country_name(params$country, to = "ISO2"))

# GBF Goals & Targets translations from https://www.cbd.int/doc/decisions/cop-15/cop-15-dec-04-es.pdf
gbf_tr <- read.xlsx("./references/translations/gbf.xlsx")
```

```{r tweak1, include=FALSE}
# National Biodiversity Targt or other term
if (params$nbsap == FALSE) {
  nbtalt <- "national biodiversity targets" #"actions"
} else {
  nbtalt <- "national biodiversity targets"
}

# alignment /similarity terms:
term <- "Similarity" # Similarity | Coverage | Alignment
terms <- c("Low", "Medium", "High") # Partial, Moderate, Strong | Mentioned, Substantial, Addressed | Mentioned, Moderate, High
termss <- "None"

# renames columns
dta <- dta %>% 
  select(-any_of(c("X", "Unnamed..3", "index", "index.1"))) %>% 
  mutate(generated_sample = substr(generated_sample, 2, nchar(generated_sample)), 
         scr = substr(generated_sample, 1, str_locate(generated_sample, "#")-2),
         dsc = substr(generated_sample, str_locate(generated_sample, "#")+1, nchar(generated_sample)))
colnames(dta) <- c("cnt", "nbt_title", "nbt_txt", "gbf_ttl", "gbf_txt", "llm_smpl", "nbt_n", "nbt_t", "nbt_ttl", "llm_scr", "llm_dscr")

# Quick test
if (length(unique(dta$cnt)) != 1) {stop()}

# eliminates unnecessary columns; eliminates cases where a score "exists" between a GBF Goal or Target and no NBT
dta <- dta %>% 
  select(nbt_title, nbt_ttl, nbt_txt, nbt_t, nbt_n, gbf_ttl, gbf_txt, llm_scr, llm_dscr) %>% 
  filter(nbt_txt != "")

# adjusts the titles of the GBF Goals and Targets
dta$gbf_ttl <- substr(dta$gbf_txt, 1, str_locate(dta$gbf_txt, "\\.") - 1)
dta$gbf_txt <- substr(dta$gbf_txt, str_locate(dta$gbf_txt, "\\.") + 2, nchar(dta$gbf_txt))
dta$gbf_ttl <- trimws(dta$gbf_ttl)

# adjusts the titles of the National Targets
dta$nbt_title <- ifelse(substr(dta$nbt_title, nchar(dta$nbt_title), nchar(dta$nbt_title)) == ".", 
                      substr(dta$nbt_title, 1, nchar(dta$nbt_title)-1), dta$nbt_title)
dta$nbt_n <- ifelse(substr(dta$nbt_n, nchar(dta$nbt_n), nchar(dta$nbt_n)) == ".", 
                      substr(dta$nbt_n, 1, nchar(dta$nbt_n)-1), dta$nbt_n)
dta$nbt_ttl <- ifelse(substr(dta$nbt_ttl, nchar(dta$nbt_ttl), nchar(dta$nbt_ttl)) == ".", 
                      substr(dta$nbt_ttl, 1, nchar(dta$nbt_ttl)-1), dta$nbt_ttl)
dta$nbt_ttl <- factor(dta$nbt_ttl, levels = unique(dta$nbt_ttl))

# number of National Targets
nbr <- length(levels(dta$nbt_ttl))
  
# creates LOW, MEDIUM and HIGH categories; based-off of the scores
dta$llm_scr <- as.numeric(gsub("\\,", "\\.", dta$llm_scr))
dta$cat <- ifelse(dta$llm_scr == 0, "None", 
                    ifelse((dta$llm_scr > 0 & dta$llm_scr < 0.333), "Low", 
                           ifelse(dta$llm_scr > 0.667, "High", "Medium")))
dta$cat <- factor(dta$cat, levels = c("None", "Low", "Medium", "High"), labels = append(termss, terms))

# ensures categorical values are as such
gbf_tr$gbf_ttl <- factor(gbf_tr$gbf_ttl, levels = unique(dta$gbf_ttl))
dta$gbf_ttl <- factor(dta$gbf_ttl, levels = levels(gbf_tr$gbf_ttl))

# ensures we're using the correct language for the GBF G&Ts
gbf_tr <- gbf_tr %>% select(gbf_ttl, txt_en) ### ENGLISH ###

# adjusts line-breaks in the GBF G&Ts
gbf_tr$txt_en[19] <- gsub("\r\n", " ", gbf_tr$txt_en[19]) ### ENGLISH ###
gbf_tr$txt_en[23] <- gsub("\r\n", " ", gbf_tr$txt_en[23]) ### ENGLISH ###

# ensuring the NBTs and GBF G&T are correct
dta <- dta %>% 
  select(-gbf_txt) %>% 
  left_join(gbf_tr) %>% 
  rename(gbf_txt = txt_en) ### ENGLISH ###

# ensures the 1st letter of all NBTs and GBF G&Ts are captalised
dta$nbt_txt <- str_replace(dta$nbt_txt, "^\\w{1}", toupper)
dta$gbf_txt <- str_replace(dta$gbf_txt, "^\\w{1}", toupper)

# ensures there are no consecutive spaces in text
dta$gbf_txt <- gsub("\\s+", "\\ ", dta$gbf_txt)
dta$nbt_txt <- gsub("\\s+", "\\ ", dta$nbt_txt)
dta$llm_dscr <- gsub("\\s+", "\\ ", dta$llm_dscr)
```

```{r tweak1_l, include=FALSE}
# adjusts separations and line=breaks in the LLM results
dta$llm_dscr <- ifelse(substr(dta$llm_dscr, 1, 1) == "S", ### ENGLISH ###
                       paste0("1. ", dta$llm_dscr), dta$llm_dscr)
dta$llm_dscr <- ifelse(substr(dta$llm_dscr, 1, 1) == "1", 
                       str_replace(dta$llm_dscr, "#", "2. "), dta$llm_dscr)
dta$llm_dscr <- ifelse(substr(dta$llm_dscr, 1, 1) == "1", 
                       str_replace(dta$llm_dscr, "\n+", ""), dta$llm_dscr)
dta$llm_dscr <- ifelse(substr(dta$llm_dscr, 1, 1) == "1", 
                       str_replace(dta$llm_dscr, "2\\.", "\n2."), dta$llm_dscr)
dta$llm_dscr <- ifelse(substr(dta$llm_dscr, 1, 1) == "1", 
                       str_replace(dta$llm_dscr, "(2\\.\\s)+", "2. "), dta$llm_dscr)
```

```{r nbt_term, include=FALSE}
# isolates the name in the NBT title
nbt <- unique(dta$nbt_t)

# condition: 1 NBT term (0), otherwise (1)
if (length(nbt) != 1) {
  cond <- 1
} else {
  cond <- 0
}

# makes additional country-specific tweaks (mostly, NBT term-related)
if (cfill == "KazakhstanN99") {
  dta$nbt_t <- ifelse(dta$nbt_t == "", substr(dta$nbt_n, 1, 2), dta$nbt_t)
  dta$nbt_n <- ifelse(substr(dta$nbt_n, 1, 1) == "2", substr(dta$nbt_n, 3, nchar(as.character(dta$nbt_n))), dta$nbt_n)
  dta$nbt_n <- ifelse(dta$nbt_n == "", gsub("\\D", "", dta$nbt_ttl), dta$nbt_n)
} 

# Ensures the NBT numbers are factors, rather than numerical
if (params$country == "Lebanon" & params$nbsap == FALSE) {
  dta$nbt_ttl <- ifelse(dta$nbt_title == "Action 18.10", as.character(substr(dta$nbt_title, nchar(as.character(dta$nbt_title)) - 4, nchar(as.character(dta$nbt_title)))), as.character(dta$nbt_ttl))
  dta$nbt_t <- factor(dta$nbt_t, levels = unique(dta$nbt_t))
  dta$nbt_n <- factor(dta$nbt_n, levels = unique(dta$nbt_n))
} else if (params$country == "South Africa") {
  dta$nbt_title <- ifelse(dta$nbt_t == "", paste0("Outcome ", dta$nbt_title), dta$nbt_title)
  dta$nbt_t <- ifelse(dta$nbt_t == "", "Outcome ", dta$nbt_t)
  dta$nbt_n <- factor(dta$nbt_n, levels = as.character(sort(as.numeric((unique(dta$nbt_n))))))
} else if (params$country == "Maldives" | params$country == "Trinidad" | cfill == "KazakhstanZEP") {
  dta$nbt_n <- factor(dta$nbt_n, levels = unique(dta$nbt_n))
} else if (any(grepl("[a-zA-Z]", dta$nbt_t)) == TRUE) {
  dta$nbt_n <- factor(dta$nbt_n, levels = as.character(sort(unique(dta$nbt_n))))
} else {
  dta$nbt_n <- factor(dta$nbt_n, levels = as.character(sort(as.numeric((unique(dta$nbt_n))))))
}
```

::: {custom-style="extra"}
**TABLE OF CONTENTS**
:::

```{r toc, echo = FALSE}
# inserts Table of Contents
block_toc(level = 2)
```

```{r formating0}
# portrait orientation, hitherto (specific margins)
block_section(sec_toc)
```

::: {custom-style="Heading 1"}
# Section 1: Introduction to the NBSAP Target Similarity Assessment Methodology {#sec1}
:::

###  {#sec11}

::: {custom-style="extra"}
*Background*
:::

::: {custom-style="Text"}
The Convention on Biological Diversity (CBD) aims to guide action to conserve biodiversity, promote the sustainable use of its components, and ensure the fair and equitable sharing of the benefits arising from the use of genetic resources. National Biodiversity Strategies and Action Plans (NBSAPs) are the main policy instrument for implementation of the CBD at the national level and contain national biodiversity targets that contribute towards the Convention.

Despite our best efforts, progress toward achieving the aims of the CBD is insufficient. In the last decade, one salient limiting contributing factor towards achievement of the Aichi Biodiversity Targets is that NBSAPs were poorly aligned with these global targets in scope, ambition, and capacity. [`r ftext("The Global Biodiversity Outlook 5", links)`](https://www.cbd.int/gbo5)[^1], released by the CBD in 2020, reveals that fewer than a quarter of the national biodiversity targets were well aligned with the Aichi Biodiversity Targets and only about a tenth of them were similar to the Aichi Biodiversity Targets and on track to be met.

At the 15^th^ CBD Conference of Parties (COP15) in 2022, 196 nations adopted the [`r ftext("Kunming-Montreal Global Biodiversity Framework", links)`](https://www.cbd.int/doc/decisions/cop-15/cop-15-dec-04-en.pdf)[^2] to put nature on a path to recovery by 2030 and achieve harmony with nature by 2050. Parties are initiating processes to align their national biodiversity targets through an inclusive whole-of-government and whole-of-society approach by the COP16. CBD Decision [`r ftext("15/6 Mechanisms for planning, monitoring, reporting, and review", links)`](https://www.cbd.int/doc/decisions/cop-15/cop-15-dec-06-en.pdf)[^3] "requests Parties to revise and update their NBSAPs [...] aligned with the Kunming-Montreal Global Biodiversity Framework and its goals and targets, including those related to means of implementation, and to submit them through the clearing-house mechanism by COP16." The Decision also requests "Parties not in a position to submit their revised NBSAPs by the COP16, to communicate national targets reflecting, as applicable, all the goals and targets of the Kunming-Montreal Global Biodiversity Framework, including those related to all means of implementation, in accordance with the reporting template provided in Annex I"[^4].

To improve national biodiversity target alignment with the Kunming-Montreal Global Biodiversity Framework, it is essential to identify which elements of the global goals and targets can be more effectively incorporated to reduce gaps. The inclusion of key stakeholders in the systematic evaluation and enhancement of national biodiversity targets can also help ensure that the country's targets contribute towards the global Framework.
:::

[^1]: <https://www.cbd.int/gbo5>

[^2]: <https://www.cbd.int/doc/decisions/cop-15/cop-15-dec-04-en.pdf>

[^3]: <https://www.cbd.int/doc/decisions/cop-15/cop-15-dec-06-en.pdf>

[^4]: See template in Annex I of Decision 15/6 [Mechanisms for planning, monitoring, reporting and review](https://www.cbd.int/doc/decisions/cop-15/cop-15-dec-06-en.pdf)

```{r scrape, include=FALSE}
# link to country's CBD-NBT repository and NBSAP references
if (params$nbsap == TRUE) {
  lnk <- paste0("https://www.cbd.int/reports/search/?country=", iso2)
  rep <- read_html(lnk) %>% html_nodes(".dgPager+ .cmsTable .cmsBold+ div") %>% html_text()
  year <- read_html(lnk) %>% html_nodes(".dgPager+ .cmsTable #ctl13_W7619_DDate") %>% html_text() %>% substr(1, 4)
  if (is_empty(year)) {year <- read_html(lnk) %>% html_nodes("#ctl15_W7619_DDate") %>% html_text() %>% substr(1, 4) %>% .[1]}
} else {
  if (params$country == "Bahamas"){ 
    lnk <- "https://www.cbd.int/doc/world/bs/bs-nr-04-en.doc"
    rep <- "The Fourth National Biodiversity Report of the Bahamas to the UNCDB"
    year <- "2011"
  } else if (params$country == "Kazakhstan") {
    if (cfill == "KazakhstanC30") {
      lnk <- "https://www.cbd.int/doc/nr/nr-06/kz-nr-06-en.pdf"
      rep <- "Concept for Conservation and Sustainable Use of the Biological Diversity of the Republic of Kazakhstan Until 2030"
      year <- "2015"
    } else if (cfill == "KazakhstanN99") {
      lnk <- "https://www.cbd.int/doc/world/kz/kz-nbsap-01-en.pdf"
      rep <- "National Strategy and Action Plan on Conservation and Sustainable Use of Biodiversity of the Republic of Kazakhstan"
      year <- "1999"
    } else if (cfill == "KazakhstanZEP") {
      lnk <- ""
      rep <- "Zhasyl Yel Program"
      year <- "2012"
    }
  } else if (params$country == "Uzbekistan") {
    lnk <- "https://lex.uz/docs/4372841#4376248"
    rep <- "Strategy for the Conservation of Biological Diversity in the Republic of Uzbekistan for the Period 2019-2028"
    year <- ""
  } else if (params$country == "Guyana") {
    lnk <- "https://www.cbd.int/doc/world/gy/gy-nbsap-v3-en.pdf"
    rep <- "National Biodiversity Strategy and Action Plan (2012-2020)"
    year <- "2014"
  } else if (params$country == "Grenada") {
    lnk <- "https://www.cbd.int/doc/world/gd/gd-nbsap-01-en.pdf"
    rep <- "Biodiversity Strategy and Action Plan"
    year <- "2000"
  } else if (params$country == "Lebanon") {
    lnk <- "https://www.cbd.int/doc/world/lb/lb-nbsap-v2-en.pdf"
    rep <- "National Biodiversity Strategy and Action Plan"
    year <- "2016"
}
}
```

::: {custom-style="extra"}
*Methods*
:::

::: {custom-style="Text"}
Advancements in Artificial Intelligence can be harnessed to support governments to more quickly advance in uncovering patterns and gaps in national biodiversity target alignment using a whole-of-government and whole-of-society approach. In this report, we use the power of Artificial Intelligence to provide an in-depth analysis of similarity between the `r nbr` `r nbtalt` found in `r params$country`’s `r year` "[`r rep`](`r lnk`)"[^5] and the four goals and 23 targets of the Kunming-Montreal Global Biodiversity Framework. We also use this Artificial Intelligence to provide detailed guidance that can inform country-led processes to strengthen alignment between national biodiversity targets with those in the Kunming-Montreal Global Biodiversity Framework and support NBSAP revision or update.

These results also have the potential to:
:::

[^5]: [`r lnk`](`r lnk`)

::: {custom-style="Text"}
-   Enable stakeholder engagement to convene around an informed neutral starting point;

-   Support more dynamic and effective engagement by providing a common starting place for advanced conservation among diverse stakeholders;

-   Expedite the alignment processes so that resources can be conserved for other aspects of NBSAP review, update, and implementation;

-   Support activities towards the GEF Global Biodiversity Framework Early Action Support Project;

-   Provide useful information towards CBD reporting requirements in advance of the COP16, such as those to be reported in Annex I of "Guidance for revising or updating national biodiversity strategies and action plans to align with the Kunming-Montreal Global Biodiversity Framework" in Decision 15/6.
:::

::: {custom-style="Text"}
A brief companion document provides a 7-page policy summary for decision makers. This work is additionally supported by the document [`r ftext("Technical Guidance to support alignment of national biodiversity targets with the Kunming-Montreal Global Biodiversity Framework", links)`](https://www.learningfornature.org/?attachment=117317&document_type=document&download_document_file=1&document_file=255)[^6], which outlines six steps for undertaking target alignment with stakeholders. In addition to the customized recommendations that are provided, the [`r ftext("CBD National Target Database", links)`](https://www.cbd.int/nbsap/targets/)[^7] also offer helpful information on the key elements within each target of the Kunming-Montreal Global Biodiversity Framework.

```{r}
fill0 <- paste0(params$country, '’s ', nbtalt)
fill1 <- ifelse(params$nbsap == TRUE, ', which were extracted from the [CBD National Target Database](https://www.cbd.int/nbsap/targets/)[^8]', '')
```

Underpinning this analysis is OpenAI’s Generative Pre-trained Transformer (GPT-3.5), a sophisticated language model proficient in comprehending and generating human-like written communication. Trained on an extensive dataset exceeding 570GB of text, this model facilitates prompt engineering, allowing users to input their own datasets and tailor the assessment type and result format. This model differs from ChatGPT, which is a socially-oriented chatbot version of GPT-3.5. The analysis behind this report harnesses the capacities of this new GPT-3.5 model to compare the goals and targets of the Kunming-Montreal Global Biodiversity Framework with `r fill0` ([Appendix 1](#appendix1))`r fill1`. The model is also trained to provide recommendations for enhanced target alignment.

During the testing phase, GPT-3.5 was chosen over two other prominent natural language processing models, Bidirectional Encoder Representations from Transformers (BERT) and Term Frequency - Inverse Document Frequency (TF-IDF). The selection was based on GPT-3.5's superior grasp of human language. A comparative analysis of the three models revealed that GPT-3.5 exhibited higher accuracy in identifying matching keywords, demonstrating an enhanced comprehension of context, nuances, and intricacies. GPT-3.5 was also selected because unlike other models, it can also generate written recommendations on opportunities to increase the similarity between national and global biodiversity goals and targets. [Appendix 3](#appendix3) describes the methods used to develop the assessment in detail, as well as the process that led to the selection of GPT-3.5, and other models that were under consideration.
:::

[^6]: [https://www.learningfornature.org/?attachment=117317&document_type=document&download_document\_](https://www.learningfornature.org/?attachment=117317&document_type=document&download_document_file=1&document_file=255) [file=1&document_file=255](https://www.learningfornature.org/?attachment=117317&document_type=document&download_document_file=1&document_file=255)

[^7]: <https://www.cbd.int/gbf/targets/>

[^8]: <https://www.cbd.int/gbf/targets/>

::: {custom-style="Text"}
This NBSAP Target Similarity Assessment evaluates the degree of similarity between each national biodiversity target with each global goal and target and assigns each pair one of the following classifications:

-   **`r terms[3]` `r term`**: The national biodiversity target and global goal or target appear to have significant overlap, containing the same overall objectives and major themes;

-   **`r terms[2]` `r term`**: The national biodiversity target and global goal or target appear to contain some of the same objectives and/or themes, although there are likely opportunities to update or revise the national biodiversity target for greater similarity;

-   **`r terms[1]` `r term`**: The national biodiversity target and global goal or target appear to contain a few of the same objectives and/or themes, although there are likely many opportunities to update or revise the national biodiversity target for greater similarity;

-   **`r termss`**: The national biodiversity target and global goal or target do not appear to contain similar objectives or themes.

Figure **1.**\@ref(fig:fig1) presents a process diagram to visualize the pathway to arrive at the score of `r tolower(terms[3])`, `r tolower(terms[2])`, `r tolower(terms[1])`, or `r tolower(termss)` `r tolower(term)` between a given national biodiversity target and a global goal or target. Table **1.**\@ref(tab:tbl1) describes some potential benefits and limitations of the assessment.
:::

```{r fig1_l, fig.dim=c(4, 4/(2346/1472)), echo = FALSE, fig.cap=paste0("Process diagram with examples of ", tolower(terms[3]), ", ", tolower(terms[2]), ", ", tolower(terms[1]), ", and no ", tolower(term), " national biodiversity targets"), fig.id="fig1", fig.cap.pre="Figure 1.", fig.autonum.start_at=1, fig.lp="sec1"}
# inserts Figure 1.1
include_graphics("references/figures/snky.png")
```

<br>

```{r tbl1_l, tab.dim = c(6, 6), echo = FALSE, tab.cap="Benefits and limitations of the NBSAP Target Similarity Assessment", tab.id="tbl1", tab.cap.pre="Table 1.", tab.autonum.start_at=1, tab.lp="sec11"}
# inserts Table 1.1
tbl <- data.frame(can = c("Assess similarity between national and global targets based on their text", paste0("Identify national biodiversity targets that have ", tolower(terms[3]), ", ", tolower(terms[2]), ", ", tolower(terms[1]), ", and no ", tolower(term), " with global goals and targets"), "Inform country-led process to align national biodiversity targets with the Framework and support subsequent NBSAP revision or update", "Serve as resource that Parties can elect to consider based on need and capacity"), cant = c("Provide definitive scores on target alignment that take into account national circumstances, baselines, or capabilities", "Make judgements on a country's alignment with the Kunming-Montreal Global Biodiversity Framework and determine which national biodiversity targets should be revised or updated and how", "Replace national target alignment with the processes, including those outlined in the document 'Technical Guidance to support alignment of national biodiversity targets with Kunming-Montreal Global Biodiversity Framework'", "Replace or qualify COP15 Decisions or related target alignment information that is or will be provided by the CBD"))
colnames(tbl) <- c("What the assessment can do", "What the assessment cannot do")

tbl %>% flextable(cwidth = c(2.5, 2.5)) %>% 
  bg(part = "header", j = 1, bg = "#00b5ff") %>% # colour swap
  bg(part = "header", j = 2, bg = "#ff8000") %>% # colour swap 
  color(part = "header", j = 1, color = "black") %>%
  color(part = "header", j = 2, color = "black") %>% 
  bold(part = "header") %>% 
  hline(part = "all") %>% 
  valign(valign = "top") %>% 
  align(align = "justify")
```

\newpage

::: {custom-style="Heading 1"}
# Section 2: Snapshot of Similarity Results of `r params$country` {#sec2}
:::

###  {#sec21}

```{r}
fill2 <- ifelse(params$nbsap == TRUE, ', per the CBD [National Target Database](https://www.cbd.int/nbsap/targets/)[^10] ([Appendix 1](#appendix1))', '')
```

::: {custom-style="Text"}
`r params$country` has `r nbr` `r nbtalt` in its `r year` "[`r rep`](`r lnk`)"[^9]`r fill2`. The GPT-3.5 model analyzed each of these `r nbr` `r nbtalt` against the four goals and 23 targets of the Kunming-Montreal Global Biodiversity Framework ([Appendix 2](#appendix2)), and provided a score of similarity for each of the `r format(27*nbr, big.mark = ",")` pairs of national and global goals and targets (`r tolower(terms[3])`, `r tolower(terms[2])`, `r tolower(terms[1])`, or `r tolower(termss)`). These findings could help `r params$country` determine where to put an additional focus on national target alignment as part of stakeholder engagement processes around NBSAP revision or update.
:::

[^9]: [`r lnk`](`r lnk`)

[^10]: <https://www.cbd.int/nbsap/targets/>

```{r subset1, include = FALSE}
# sub-sets data, giving count of NBTs per category per GBF Goal or Target
dtgr0 <- dta %>% select(gbf_ttl, cat) %>% 
  table() %>% as_tibble() %>% 
  filter(cat != termss) %>% 
  filter(gbf_ttl %in% levels(dta$gbf_ttl)[1:4]) %>% 
  mutate(catt = paste(cat, substr(gbf_ttl, 10,10)))
levels(dtgr0$gbf_ttl) <- levels(dta$gbf_ttl)[1:4]

# sub-sets data, giving a count of NBTs per category per GBF Goal or Target
dtaa <- dta %>% select(gbf_ttl, cat) %>% 
  table() %>% as_tibble() %>% 
  filter(cat != termss)
dtaa$gbf_ttl <- factor(dtaa$gbf_ttl, levels = levels(dta$gbf_ttl))
dtaa$cat <- factor(dtaa$cat, levels = terms)

# sub-sets data, giving a count of the number of pairings per category
dtax <- dtaa %>% 
  select(-gbf_ttl) %>% 
  group_by(cat) %>% 
  summarise(n = sum(n))

# sub-sets data, giving total number of similarities by GBF Goal
dtgr000 <- dtgr0 %>% 
  group_by(gbf_ttl) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n))
```

```{r subset2, include=FALSE, warning=FALSE}
# sub-sets data, giving a count of NBTs per GBF Goal or Target (ordered)
dtaaa <- dtaa %>% select(gbf_ttl, n) %>% 
  group_by(gbf_ttl) %>% 
  summarise(n = sum(n)) %>% 
  arrange(desc(n))
```

```{r subset2_l, include=FALSE, warning=FALSE}
# sub-sets data, giving NBT count by category and total, by GBF Target
dtgr000z <- dta %>% select(gbf_ttl, cat) %>% 
  table() %>% as_tibble() %>% 
  filter(cat != termss) %>% 
  filter(!(gbf_ttl %in% levels(dta$gbf_ttl)[1:4])) %>% 
  pivot_wider(names_from = cat, values_from = n) %>% 
  mutate(sim = get(terms[1]) + get(terms[2]) + get(terms[3])) %>% arrange(desc(sim))

# sub-sets of data, giving the total number of GBF Goals or Targets with some similarity, by NBT
dtgr_n <- dta %>% 
  select(nbt_ttl, cat) %>% 
  table() %>% 
  as.data.frame() %>% 
  filter(cat != termss) %>% 
  pivot_wider(names_from = cat, values_from = Freq) %>% 
  mutate(Tot = get(terms[1]) + get(terms[2]) + get(terms[3])) %>% 
  mutate(Sim = ifelse(Tot == 0, 1, 0))

# number of NBTs with at least one similarity (for text)
pair_sim <- nbr - sum(dtgr_n$Sim)

# sub-set of data, giving lit of GBF Targets with no/o similarities (for text)
zero_gbff <- dtaaa %>% 
  filter(n == 0) %>% 
  mutate(gbf_ttl = factor(gbf_ttl, levels = levels(dtaa$gbf_ttl))) %>% 
  arrange(gbf_ttl)
zgbf <- substr(zero_gbff$gbf_ttl, str_locate(zero_gbff$gbf_ttl, " ")+1, nchar(as.character(zero_gbff$gbf_ttl)))
zgls <- zgbf[grepl("\\D", zgbf)]
ztrg <- zgbf[grepl("\\d", zgbf)]

zero_gls <- zgls[1]
if (length(zgls) > 1) {
  for (i in 2:length(zgls)){
  if (i == length(zgls)){
    zero_gls <- paste0(zero_gls, ", and ", zgls[i])
  } else {
    zero_gls <- paste0(zero_gls, ", ", zgls[i])
  }
  }
  zero_gls <- paste0("Goals ", zero_gls)
} else if (length(zgls) == 1) {
  zero_gls <- paste0("Goal ", zero_gls)
} else if (is_empty(zgls)) {
  zero_gls <- ""
}
 
zero_trg <- ztrg[1]
if (length(ztrg) > 1) {
  for (i in 2:length(ztrg)){
  if (i == length(ztrg)){
    zero_trg <- paste0(zero_trg, ", and ", ztrg[i])
  } else {
    zero_trg <- paste0(zero_trg, ", ", ztrg[i])
  }
  }
  zero_trg <- paste0("Targets ", zero_trg)
} else if (length(ztrg) == 1) {
  zero_trg <- paste0("Target ", zero_trg)
} else if (is_empty(ztrg)) {
  zero_trg <- ""
} 

if (!is_empty(zgls) & !is_empty(ztrg)) {
  zero_gbf <- paste0("The global goals and targets that are not represented in the ", nbtalt, " and have no similarity are ", 
                    zero_gls, ", and ", zero_trg)
} else if (!is_empty(zgls) & is_empty(ztrg)) {
  zero_gbf <- paste0("The global goals and targets that are not represented in the ", nbtalt, " and have no similarity are ", 
                    zero_gls)
} else if (is_empty(zgls) & !is_empty(ztrg)) {
  zero_gbf <- paste0("The global goals and targets that are not represented in the ", nbtalt, " and have no similarity are ", 
                    zero_trg)
} else if (!is_empty(zgls) & !is_empty(ztrg)) {
  zer_gbf <- paste0("Every one of the global goals and targets are represented in the ", nbtalt, " and have some similarities")
}
```

::: {custom-style="Text"}
Key national findings:

-   There `r ifelse((dtax %>% filter(cat == "High"))$n == 1, "is", "are")` `r ifelse(filter(dtax, cat == terms[3])$n == 0, "no", filter(dtax, cat == terms[3])$n)` `r ifelse((dtax %>% filter(cat == "High"))$n == 1, "pair", "pairs")` of national and global goals or targets with `r tolower(terms[3])` `r tolower(term)`, `r ifelse(filter(dtax, cat == terms[2])$n == 0, "none", filter(dtax, cat == terms[2])$n)` with `r tolower(terms[2])` `r tolower(term)`, and `r ifelse(filter(dtax, cat == terms[1])$n == 0, "none", filter(dtax, cat == terms[1])$n)` with `r tolower(terms[1])` `r tolower(term)`;

-   Overall, `r round(100*(pair_sim/nbr), 0)`% of the `r nbtalt` (`r pair_sim` out of `r nbr`) are similar to one or more of the global goals and targets in `r tolower(terms[3])`, `r tolower(terms[2])`, or `r tolower(terms[1])` degree;

-   In total, `r ifelse(sum(dtgr_n$Sim) == 0, "none", sum(dtgr_n$Sim))` of `r fill0` `r ifelse(sum(dtgr_n$Sim) == 1, "shows", "show")` no similarity with any of the global goals and targets;

-   The global goals and targets best represented in the `r nbtalt` are `r dtaaa$gbf_ttl[1]`, `r dtaaa$gbf_ttl[2]`, `r dtaaa$gbf_ttl[3]`, `r dtaaa$gbf_ttl[14]`, and `r dtaaa$gbf_ttl[5]` (Figure **2.**\@ref(fig:fig5));

-   `r zero_gbf`.

Key summary figures and tables:

-   Figure **2.**\@ref(fig:fig2) provides an overview of similarity between `r nbtalt` and the four global goals of the Kunming-Montreal Global Biodiversity Framework. This figure can be used to quickly identify where similarities and gaps exist;

-   Figures **2.**\@ref(fig:fig3) and **2.**\@ref(fig:fig4) provide an overview of similarity between `r nbtalt` and the 23 global targets of the Kunming-Montreal Global Biodiversity Framework. Figure **2.**\@ref(fig:fig3) focuses on global targets 1-11 and Figure **2.**\@ref(fig:fig4) focuses on global targets 12-23. These figures are especially useful to countries that have a large number of `r nbtalt` because they can show where national targets can work in conjunction to address the different elements of a specific global target;

-   Figure **2.**\@ref(fig:fig5) expands on Figures **2.**\@ref(fig:fig2)-**2.**\@ref(fig:fig4) by displaying global goal and target similarity side by side, where the height of each column indicates how many `r nbtalt` show some similarity with each global goal or target, and;

-   Table **2.**\@ref(tab:tbl2) lists the names of `r nbtalt` that have similarity with each of the global goals and targets.
:::

```{r subset3, echo=FALSE}
# sub-set of data, giving NBTs with no parallel GBF Goals or Targets
idtgr <- dta %>% select(nbt_ttl, cat) %>% 
  table() %>% as_tibble() %>% 
  pivot_wider(names_from = cat, values_from = n) %>% 
  mutate(nn = get(terms[1]) + get(terms[2]) + get(terms[3])) %>% 
  select(nbt_ttl, nn) %>% 
  filter(nn == 0)
```

```{r subset3_l, echo=FALSE}
dtgr0z <- dta %>% select(gbf_ttl, cat) %>% table() %>% 
  as_tibble() %>% filter(cat != termss) %>%
  filter(!(gbf_ttl %in% levels(dta$gbf_ttl)[1:4]))
```

```{r txt_aux1, echo=FALSE}
# number of GBF Goals or Targets with at least one NBT parallel (for text)
text_aux <- ifelse(is.na(table(dtgr000$n == 0)[2]), "each", 4 - table(dtgr000$n == 0)[2])

# number of GBF Targets with at least one NBT parallel (for text)
text_auxx <- ifelse(is.na(table(dtgr000z$sim == 0)[2]), "each", 23 - table(dtgr000z$sim == 0)[2])

# sub-set of data, giving the count of NBT similarities per category of each GBF Target
# text for the GBF Goal with the least number of similarities (for text)
if (0 %in% dtgr000$n == FALSE){
  goals1 <- paste0("The lowest number of similar national targets is observed in ", dtgr000$gbf_ttl[4], " (", dtgr000$n[4], ")")
} else {
  goals1 <- paste0(dtgr000$gbf_ttl[4], " has no similar ", nbtalt)
}

# text regarding the count of NBTs with no similarity (for text)
if (length(idtgr$nn) == 0){
  goals2 <- paste0("All the ", nbtalt, " were found to have some similarity")
} else if (length(idtgr$nn) == 1){
  goals2 <- paste0("In total, only one of the ",  nbr, " was found to have no similarity, and is not represented in this pie chart")
} else {
  goals2 <- paste0("In total, ", length(idtgr$nn), " of the ",  nbr, " were found to have no similarity, and are not represented in this pie chart")
}

targets3s <- dtgr000z %>% filter(sim == 0)
targets3s$gbf_ttl <- factor(targets3s$gbf_ttl, levels = c("Goal A", "Goal B", "Goal C", "Goal D", 
                                                "Target 1", "Target 2", "Target 3", "Target 4", "Target 5", "Target 6", 
                                                "Target 7", "Target 8", "Target 9", "Target 10", "Target 11", "Target 12", 
                                                "Target 13", "Target 14", "Target 15", "Target 16", "Target 17", "Target 18", 
                                                "Target 19", "Target 20", "Target 21", "Target 22", "Target 23"))
# text regarding the count of GBF Targets with no similarity (for text)
if (length((dtgr0z %>% filter(n == 0))$n) == length(dtgr0z$n)){
  targets2 <- "All the global targets were found to have some similarity"
  targets3 <- "."
} else if (length((dtgr0z %>% filter(n == 0))$n) == 1) {
  targets2 <- paste0("A single global target was found to have no similarity: ", (dtgr0z %>% filter(n == 0))$gbf_ttl)
  targets3 <- "."
} else {
  targets2 <- paste0("The global targets that lack similar ", nbtalt, " are: ")
  targets3 <- zero_trg
}
```

```{r}
fill3 <- ifelse(params$nbsap == TRUE, paste0(params$country, '’s'), "the")
```

::: {custom-style="Text"}
The analysis indicates that `r text_aux` of the goals of the Kunming-Montreal Global Biodiversity Framework `r ifelse(text_aux == 1, "has", "have")` at least one parallel `r substr(nbtalt, 1, nchar(as.character(nbtalt))-1)` of `r tolower(terms[3])`, `r tolower(terms[2])`, or `r tolower(terms[1])` `r tolower(term)`. Of `r fill3` `r nbr` `r nbtalt`, `r dtgr000$gbf_ttl[1]` has the highest number of similar targets (`r dtgr000$n[1]`), followed by `r dtgr000$gbf_ttl[2]` (`r dtgr000$n[2]`), and `r dtgr000$gbf_ttl[3]` (`r dtgr000$n[3]`). `r goals1`. Of the `r sum(dtgr0$n)` `r ifelse(sum(dtgr0$n) == 1, "pair", "pairs")` of global goals and `r nbtalt` with some similarity, approximately `r round(100*sum(dtgr0[9:12, 3])/sum(dtgr0$n), 0)`% have `r tolower(terms[3])` `r tolower(term)`, `r round(100*sum(dtgr0[5:8, 3])/sum(dtgr0$n), 0)`% have `r tolower(terms[2])` `r tolower(term)`, and `r round(100*sum(dtgr0[1:4, 3])/sum(dtgr0$n), 0)`% have `r tolower(terms[1])` `r tolower(term)`. `r goals2`.
:::

```{r grf_aux0, include=FALSE}
# creates the colour palette used in most graphics
cols <- c("#AFFF57", "#59DC3D", "#00A54A", "white")
names(cols) <- c("Low", "Medium", "High", "NBT")

# enables a number/letter to be drawn atop a legend key
keyl <- c("1")
names(keyl) <- c("NBT")

draw_key_cust <- function(data, params, size) {
  data_text <- data
  data_text$label <- keyl[names(cols)[match(data$fill, cols)]]
  data_text[c("fill")] <- NULL
  data_text$colour <- "black"
  data_text$alpha <- 1
  data_text$size <- 11 / .pt # ball text size in legend
  
grid::grobTree(
  draw_key_dotplot(data, list()),
  draw_key_text(data_text, list())
  )
}

b_size <- 7
bt_size <- 2.5
```

```{r subset4, include=FALSE}
# subsets for the rings in the 3 "flower" figures
dta$gbf_ttl <- factor(dta$gbf_ttl, levels = unique(dta$gbf_ttl))

dtgr <- dta %>% 
  filter(llm_scr != 0) %>% 
  select(any_of(c("gbf_ttl", "nbt_ttl", "cat")))
dtgr$cat <- dtgr$cat %>% 
  droplevels(termss)
dtgr <- dtgr %>% 
  arrange(cat, gbf_ttl) %>% 
  mutate(aux = paste0(gbf_ttl, cat))
dtgr$auxx <- NA
dtgr$auxx[1] <- 1
for (i in 2:length(dtgr$aux)){
  dtgr$auxx[i] <- ifelse(dtgr$aux[i] == dtgr$aux[i-1], dtgr$auxx[i-1] + 1, 1)
}

# finds if any GBF Goal or Target has 0 similarities and ensures this doesn't affect the visual representation of that GBF Goal or Target
gbf_ttl <- setdiff(levels(dtgr$gbf_ttl), unique(dtgr$gbf_ttl))
if (length(gbf_ttl != 0)){
  txt <- str_trim(gbf_ttl[1])
  for (i in 2:length(gbf_ttl)){
    if (i == length(gbf_ttl)){txt <- paste0(txt, ", and ", str_trim(gbf_ttl[i]), ".")} 
    else {txt <- paste0(txt, ", ", str_trim(gbf_ttl[i]))}
  }
} else {
  txt <- "."
  gbf_ttl <- NA
}

dtgr_d <- data.frame(gbf_ttl, nbt_ttl = NA, cat = NA, aux = NA, auxx = NA)
dtgr <- rbind(dtgr, dtgr_d)
dtgr$gbf_ttl <- factor(dtgr$gbf_ttl, levels = levels(dta$gbf_ttl))

dtgr_tbl <- dtgr %>% select(gbf_ttl, cat) %>% group_by(gbf_ttl) %>% table() %>% as_tibble() %>% 
  pivot_wider(names_from = cat, values_from = n)
```

```{r grf_aux1, include=FALSE}
# sub-sets data, giving NBT number, GBF Target, category and position (for "flower" plot 1)
dtgr_tbl1 <- dtgr_tbl %>% 
  filter(gbf_ttl %in% levels(dta$gbf_ttl)[1:4])
dtgr1 <- dtgr %>% 
  filter(gbf_ttl %in% levels(dta$gbf_ttl)[1:4])
dtgr1$auxxx <- NA

# inner ring
bh1 <- max(dtgr_tbl1[[terms[3]]])
h1 <- 1; brh1 <- 1; bdh1 <- 0 # change for number of balls per ring
if (is_empty(dtgr1$auxxx[dtgr1$cat == terms[3]]) == FALSE) {
  while (bh1 > 0) {
    dtgr1$auxxx[dtgr1$cat == terms[3] & (bdh1 < dtgr1$auxx & dtgr1$auxx <= bdh1 + brh1)] <- 3*h1
    bh1 <- bh1 - brh1
    h1 <- h1 + 1; bdh1 <- bdh1 + brh1; brh1 <- brh1 + 1
  }}
# intermediary ring
bm1 <- max(dtgr_tbl1[[terms[2]]])
m1 <- 1; brm1 <- 3; bdm1 <- 0 # change for number of balls per ring
if (is_empty(dtgr1$auxxx[dtgr1$cat == terms[2]]) == FALSE) {
  while (bm1 > 0) {
    dtgr1$auxxx[dtgr1$cat == terms[2] & (bdm1 < dtgr1$auxx & dtgr1$auxx <= bdm1 + brm1)] <- 3*m1
    bm1 <- bm1 - brm1
    m1 <- m1 + 1; bdm1 <- bdm1 + brm1; brm1 <- brm1 + 1
  }}
# outer ring
bl1 <- max(dtgr_tbl1[[terms[1]]])
l1 <- 1; bdl1 <- 0; brl1 <- 5 # change for number of balls per ring
if (is_empty(dtgr1$auxxx[dtgr1$cat == terms[1]]) == FALSE) {
  while (bl1 > 0) {
    dtgr1$auxxx[dtgr1$cat == terms[1] & (bdl1 < dtgr1$auxx & dtgr1$auxx <= bdl1 + brl1)] <- 3*l1
    bl1 <- bl1 - brl1
    l1 <- l1 + 1; bdl1 <- bdl1 + brl1; brl1 <- brl1 + 1
  }}

dtgr1$catt <- paste0(dtgr1$cat, dtgr1$auxxx)
levels(dtgr1$catt) <- c(paste0(terms[1], max(ifelse(l1 == 1, 1, 3*(l1-1)), 4):1), 
                        paste0(terms[2], max(ifelse(m1 == 1, 1, 3*(m1-1)), 4):1), 
                        paste0(terms[3], max(ifelse(h1 == 1, 1, 3*(h1-1)), 3):0))

dtgr1_aux <- as.data.frame(levels(dtgr1$catt)) %>% 
  rename(catt = "levels(dtgr1$catt)") %>% 
  mutate(y = dim(.)[1]:1)

dtgr1 <- dtgr1 %>% 
  select(any_of(c("gbf_ttl", "nbt_ttl", "cat", "catt")))

dtgr1 <- dtgr1 %>% 
  mutate(gbf_ttl = droplevels(gbf_ttl)) %>% 
  filter(complete.cases(.)) %>% 
  group_by(catt, gbf_ttl) %>% 
  mutate(n = (row_number() - mean(n()))/n(),
         n = (n - mean(n))*0.9 + as.numeric(gbf_ttl)) %>% 
  left_join(dtgr1_aux)

rect1 <- data.frame(x0 = c(0.5, 0.5, 0.5), xn = c(4.5, 4.5, 4.5), 
                    y0 = c(max(ifelse(h1 == 1, 1, 3*(h1-1)), 3) + max(ifelse(m1 == 1, 1, 3*(m1-1)), 4) + 3, 
                           max(ifelse(h1 == 1, 1, 3*(h1-1)), 3) + 2, 
                           0), 
                    yn = c(max(ifelse(h1 == 1, 1, 3*(h1-1)), 3) + max(ifelse(m1 == 1, 1, 3*(m1-1)), 4) + max(ifelse(l1 == 1, 1, 3*(l1-1)), 4) + 4, 
                           max(ifelse(h1 == 1, 1, 3*(h1-1)), 3) + max(ifelse(m1 == 1, 1, 3*(m1-1)), 4) + 3, 
                           max(ifelse(h1 == 1, 1, 3*(h1-1)), 3) + 2), 
                    lab = factor(terms, levels = terms))
```

```{r clean3}
rm(dtgr_tbl1, dtgr1_aux, bh1, h1, bdh1, brh1, bm1, m1, bdm1, brm1, bl1, l1, bdl1, brl1)
```

```{r grf_aux2, include=FALSE}
# sub-sets data, giving NBT number, GBF Target, category and position (for "flower" plot 2)
slc <- 5:15
dtgr_tbl2 <- dtgr_tbl %>% 
    filter(gbf_ttl %in% levels(dta$gbf_ttl)[slc])
dtgr2 <- dtgr %>% 
  filter(gbf_ttl %in% levels(dta$gbf_ttl)[slc])
dtgr2$auxxx <- NA

# inner ring
bh2 <- max(dtgr_tbl2[[terms[3]]])
h2 <- 1; bdh2 <- 0; brh2 <- 1 # change for number of balls per ring
if (is_empty(dtgr2$auxxx[dtgr2$cat == terms[3]]) == FALSE) {
  while (bh2 > 0) {
    dtgr2$auxxx[dtgr2$cat == terms[3] & (bdh2 < dtgr2$auxx & dtgr2$auxx <= bdh2 + brh2)] <- 3*h2
    bh2 <- bh2 - brh2
    h2 <- h2 + 1; bdh2 <- bdh2 + brh2; brh2 <- brh2 + 1
  }}
# intermediary ring
bm2 <- max(dtgr_tbl2[[terms[2]]])
m2 <- 1; bdm2 <- 0; brm2 <- 1 # change for number of balls per ring
if (is_empty(dtgr2$auxxx[dtgr2$cat == terms[2]]) == FALSE) {
  while (bm2 > 0) {
    dtgr2$auxxx[dtgr2$cat == terms[2] & (bdm2 < dtgr2$auxx & dtgr2$auxx <= bdm2 + brm2)] <- 3*m2
    bm2 <- bm2 - brm2
    m2 <- m2 + 1; bdm2 <- bdm2 + brm2; brm2 <- brm2 + 1
  }}
# outer ring
bl2 <- max(dtgr_tbl2[[terms[1]]])
l2 <- 1; bdl2 <- 0; brl2 <- 2 # change for number of balls per ring
if (is_empty(dtgr2$auxxx[dtgr2$cat == terms[1]]) == FALSE) {
  while (bl2 > 0) {
    dtgr2$auxxx[dtgr2$cat == terms[1] & (bdl2 < dtgr2$auxx & dtgr2$auxx <= bdl2 + brl2)] <- 3*l2
    bl2 <- bl2 - brl2
    l2 <- l2 + 1; bdl2 <- bdl2 + brl2; brl2 <- brl2 + 1
  }}

dtgr2$catt <- paste0(dtgr2$cat, dtgr2$auxxx)
levels(dtgr2$catt) <- c(paste0(terms[1], max(ifelse(l2 == 1, 1, 3*(l2-1)), 4):1), 
                        paste0(terms[2], max(ifelse(m2 == 1, 1, 3*(m2-1)), 4):1), 
                        paste0(terms[3], max(ifelse(h2 == 1, 1, 3*(h2-1)), 3):0))

dtgr2_aux <- as.data.frame(levels(dtgr2$catt)) %>% 
  rename(catt = "levels(dtgr2$catt)") %>% 
  mutate(y = dim(.)[1]:1)

dtgr2 <- dtgr2 %>% 
  select(any_of(c("gbf_ttl", "nbt_ttl", "cat", "catt")))

dtgr2 <- dtgr2 %>% 
  mutate(gbf_ttl = droplevels(gbf_ttl)) %>% 
  filter(complete.cases(.)) %>% 
  group_by(catt, gbf_ttl) %>% 
  mutate(n = (row_number() - mean(n()))/n(),
         n = (n - mean(n))*0.9 + as.numeric(gbf_ttl)) %>% 
  left_join(dtgr2_aux)

rect2 <- data.frame(x0 = c(0.5, 0.5, 0.5), xn = c(length(slc) + 0.5, length(slc) + 0.5, length(slc) + 0.5), 
                    y0 = c(max(ifelse(h2 == 1, 1, 3*(h2-1)), 3) + max(ifelse(m2 == 1, 1, 3*(m2-1)), 4) + 3, 
                           max(ifelse(h2 == 1, 1, 3*(h2-1)), 3) + 2, 
                           0), 
                    yn = c(max(ifelse(h2 == 1, 1, 3*(h2-1)), 3) + max(ifelse(m2 == 1, 1, 3*(m2-1)), 4) + max(ifelse(l2 == 1, 1, 3*(l2-1)), 4) + 4, 
                           max(ifelse(h2 == 1, 1, 3*(h2-1)), 3) + max(ifelse(m2 == 1, 1, 3*(m2-1)), 4) + 3, 
                           max(ifelse(h2 == 1, 1, 3*(h2-1)), 3) + 2), 
                    lab = factor(terms, levels = terms))
```

```{r clean4}
rm(dtgr_tbl2, dtgr2_aux, bh2, h2, bdh2, brh2, bm2, m2, bdm2, brm2, bl2, l2, bdl2, brl2)
```

```{r grf_aux3, include=FALSE}
# sub-sets data, giving NBT number, GBF Target, category and position (for "flower" plot 3)
slc <- 16:27
dtgr_tbl3 <- dtgr_tbl %>% 
    filter(gbf_ttl %in% levels(dta$gbf_ttl)[slc])
dtgr3 <- dtgr %>% 
  filter(gbf_ttl %in% levels(dta$gbf_ttl)[slc])
dtgr3$auxxx <- NA

# inner ring
bh3 <- max(dtgr_tbl3[[terms[3]]])
h3 <- 1; bdh3 <- 0; brh3 <- 1 # change for number of balls per ring
if (is_empty(dtgr3$auxxx[dtgr3$cat == terms[3]]) == FALSE) {
  while (bh3 > 0) {
    dtgr3$auxxx[dtgr3$cat == terms[3] & (bdh3 < dtgr3$auxx & dtgr3$auxx <= bdh3 + brh3)] <- 3*h3
    bh3 <- bh3 - brh3
    h3 <- h3 + 1; bdh3 <- bdh3 + brh3; brh3 <- brh3 + 1
  }}
# intermediary ring
bm3 <- max(dtgr_tbl3[[terms[2]]])
m3 <- 1; bdm3 <- 0; brm3 <- 1 # change for number of balls per ring
if (is_empty(dtgr3$auxxx[dtgr3$cat == terms[2]]) == FALSE) {
  while (bm3 > 0) {
    dtgr3$auxxx[dtgr3$cat == terms[2] & (bdm3 < dtgr3$auxx & dtgr3$auxx <= bdm3 + brm3)] <- 3*m3
    bm3 <- bm3 - brm3
    m3 <- m3 + 1; bdm3 <- bdm3 + brm3; brm3 <- brm3 + 1
  }}
# outer ring
bl3 <- max(dtgr_tbl3[[terms[1]]])
l3 <- 1; bdl3 <- 0; brl3 <- 5 # change for number of balls per ring
if (is_empty(dtgr3$auxxx[dtgr3$cat == terms[1]]) == FALSE) {
  while (bl3 > 0) {
    dtgr3$auxxx[dtgr3$cat == terms[1] & (bdl3 < dtgr3$auxx & dtgr3$auxx <= bdl3 + brl3)] <- 3*l3
    bl3 <- bl3 - brl3
    l3 <- l3 + 1; bdl3 <- bdl3 + brl3; brl3 <- brl3 + 1
  }}

dtgr3$catt <- paste0(dtgr3$cat, dtgr3$auxxx)
levels(dtgr3$catt) <- c(paste0(terms[1], max(ifelse(l3 == 1, 1, 3*(l3-1)), 4):1), 
                        paste0(terms[2], max(ifelse(m3 == 1, 1, 3*(m3-1)), 4):1), 
                        paste0(terms[3], max(ifelse(h3 == 1, 1, 3*(h3-1)), 3):0))

dtgr3_aux <- as.data.frame(levels(dtgr3$catt)) %>% 
  rename(catt = "levels(dtgr3$catt)") %>% 
  mutate(y = dim(.)[1]:1)

dtgr3 <- dtgr3 %>% 
  select(any_of(c("gbf_ttl", "nbt_ttl", "cat", "catt")))

dtgr3 <- dtgr3 %>% 
  mutate(gbf_ttl = droplevels(gbf_ttl)) %>% 
  filter(complete.cases(.)) %>% 
  group_by(catt, gbf_ttl) %>% 
  mutate(n = (row_number() - mean(n()))/n(),
         n = (n - mean(n))*0.9 + as.numeric(gbf_ttl)) %>% 
  left_join(dtgr3_aux)

rect3 <- data.frame(x0 = c(0.5, 0.5, 0.5), xn = c(length(slc) + 0.5, length(slc) + 0.5, length(slc) + 0.5), 
                    y0 = c(max(ifelse(h3 == 1, 1, 3*(h3-1)), 3) + max(ifelse(m3 == 1, 1, 3*(m3-1)), 4) + 3, 
                           max(ifelse(h3 == 1, 1, 3*(h3-1)), 3) + 2, 
                           0), 
                    yn = c(max(ifelse(h3 == 1, 1, 3*(h3-1)), 3) + max(ifelse(m3 == 1, 1, 3*(m3-1)), 4) + max(ifelse(l3 == 1, 1, 3*(l3-1)), 4) + 4, 
                           max(ifelse(h3 == 1, 1, 3*(h3-1)), 3) + max(ifelse(m3 == 1, 1, 3*(m3-1)), 4) + 3, 
                           max(ifelse(h3 == 1, 1, 3*(h3-1)), 3) + 2), 
                    lab = factor(terms, levels = terms))
```

```{r clean5}
rm(dtgr_tbl3, dtgr3_aux, bh3, h3, bdh3, brh3, bm3, m3, bdm3, brm3, bl3, l3, bdl3, brl3)
```

```{r plot1, echo=FALSE, warning=FALSE, fig.align="center", fig.width=6, fig.height = 3.5, fig.retina=8, fig.cap=paste0(" ", term, " between ", nbtalt, " and the global biodiversity goals of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig2", fig.cap.pre="Figure 2.", fig.lp="sec2"}
# "flower" figure 1
ggplot() + 
geom_rect(data = rect1, 
          mapping = aes(xmin = x0, xmax = xn, ymin = y0, ymax = yn, 
          fill = lab)) + 
scale_fill_manual(term,
                  values = unname(cols[-4])) +
geom_vline(xintercept = seq(0.5, 3.5, 1)) + 
    geom_point(data = dtgr1, aes(n, y, color = "black"), 
               size = b_size, fill = "white", shape = 21,  # ball size in graph
               key_glyph = "cust"
               ) + 
      geom_text(data = dtgr1, aes(n, y, label = nbt_ttl), 
                size = bt_size) + # ball text size in graph
      scale_color_manual("", values = "black", 
                         labels = paste0(gsub(" ", "\n", str_to_title(substr(nbtalt, 1, nchar(as.character(nbtalt))-1))), "\nnumber")) + 
scale_x_continuous(breaks = 1:4, 
                   labels = levels(dtgr1$gbf_ttl)[1:4]) + 
coord_curvedpolar() + 
theme_void() + 
guides(color = guide_legend(override.aes = list(size = 14))) + # ball size in legend
theme(axis.text.x = element_text(size = 10, face = 2), 
      legend.title = element_text(size=14), 
      legend.text = element_text(size=12))
```

```{r clean6, include=FALSE}
rm(rect1, dtgr1, idtgr, dtgr_n, dtax, dtgr0, dtaaa, goals1, goals2, pair_sim, zero_gbf)
```

::: {custom-style="Text"}
The analysis indicates that `r text_auxx` of the 23 targets of the Kunming-Montreal Global Biodiversity Framework `r ifelse(text_auxx == 1, "has", "have")` at least one parallel `r nbtalt`. `r dtgr000z$gbf_ttl[1]` has the highest number of similar `r nbtalt` (`r dtgr000z$sim[1]`), followed by `r dtgr000z$gbf_ttl[2]` (`r dtgr000z$sim[2]`), and `r dtgr000z$gbf_ttl[3]` (`r dtgr000z$sim[3]`). Of the `r sum(dtgr0z$n)` pairs of national and global targets with some similarity, `r ifelse(round(100*sum(dtgr0z[47:69, 3])/sum(dtgr0z$n), 0) == 0, "none", round(100*sum(dtgr0z[47:69, 3])/sum(dtgr0z$n), 0))` have `r tolower(terms[3])` `r tolower(term)`, `r ifelse(round(100*sum(dtgr0z[24:46, 3])/sum(dtgr0z$n), 0) == 0, "none", round(100*sum(dtgr0z[24:46, 3])/sum(dtgr0z$n), 0))` have `r tolower(terms[2])` `r tolower(term)`, and `r ifelse(round(100*sum(dtgr0z[1:23, 3])/sum(dtgr0z$n), 0) == 0, "none", round(100*sum(dtgr0z[1:23, 3])/sum(dtgr0z$n), 0))` have `r tolower(terms[1])` `r tolower(term)`. `r targets2``r targets3 `.
:::

```{r formating1}
# portrait orientation, hitherto
block_section(sec_port)
```

```{r plot2, echo=FALSE, warning=FALSE, fig.align="center", fig.width=10.59, fig.height=6.73, fig.retina=8, fig.cap=paste0(" ", term, " between ", nbtalt, " and Targets 1-11 of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig3", fig.cap.pre="Figure 2.", fig.lp="sec2"}
# "flower" figure 2
ggplot() + 
geom_rect(data = rect2, 
          mapping = aes(xmin = x0, xmax = xn, ymin = y0, ymax = yn, 
          fill = lab)) + 
scale_fill_manual(term,
                  values = unname(cols[-4])) +
geom_vline(xintercept = seq(0.5, 10.5, 1)) + 
    geom_point(data = dtgr2, aes(n, y, color = "black"), 
               size = b_size, fill = "white", shape = 21,  # ball size
               key_glyph = "cust"
               ) +
    geom_text(data = dtgr2, aes(n, y, label = nbt_ttl), 
              size = bt_size) + # ball text size
    scale_color_manual("", values = "black", 
                       labels = paste0(gsub(" ", "\n", str_to_title(substr(nbtalt, 1, nchar(as.character(nbtalt))-1))), "\nnumber")) + 
scale_x_continuous(breaks = 1:11, 
                   labels = levels(dtgr2$gbf_ttl)[1:11]) + 
coord_curvedpolar() + 
theme_void() + 
guides(color = guide_legend(override.aes = list(size = 15))) + 
theme(axis.text.x = element_text(size = 20, face = 2), 
      legend.title = element_text(size=14), 
      legend.text = element_text(size=12))
```

```{r clean7, echo=FALSE}
rm(rect2, dtgr2, dtgr000, dtgr000z, dtgr0z, targets2, targets3, text_aux, text_auxx)
```

```{r plot3, echo=FALSE, warning=FALSE, fig.align="center", fig.width=10.59, fig.height=6.73, fig.retina=8, fig.cap=paste0(" ", term, " between ", nbtalt, " and Targets 12-23 of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig4", fig.cap.pre="Figure 2.", fig.lp="sec2"}
# "flower" figure 3
ggplot() + 
geom_rect(data = rect3, 
          mapping = aes(xmin = x0, xmax = xn, ymin = y0, ymax = yn, 
          fill = lab)) + 
scale_fill_manual(term,
                  values = unname(cols[-4])) +
geom_vline(xintercept = seq(0.5, 11.5, 1)) + 
    geom_point(data = dtgr3, aes(n, y, color = "black"), 
               size = b_size, fill = "white", shape = 21,  # ball size (9)
               key_glyph = "cust"
               ) +
    geom_text(data = dtgr3, aes(n, y, label = nbt_ttl), 
              size = bt_size) + # ball text size (3)
scale_color_manual("", values = "black", 
                   labels = paste0(gsub(" ", "\n", str_to_title(substr(nbtalt, 1, nchar(as.character(nbtalt))-1))), "\nnumber")) + 
scale_x_continuous(breaks = 1:12, 
                   labels = levels(dtgr3$gbf_ttl)[1:12]) + 
coord_curvedpolar() + 
theme_void() + 
guides(color = guide_legend(override.aes = list(size = 15))) + 
theme(axis.text.x = element_text(size = 20, face = 2), 
      legend.title = element_text(size=14), 
      legend.text = element_text(size=12))
```

```{r clean8, echo=FALSE}
rm(rect3, dtgr3, keyl)
```

```{r formating2}
# landscape orientation, hitherto
block_section(sec_land)
```

```{r plot4, fig.width=5.5, fig.asp=2/3, fig.align="center", echo = FALSE, warning = FALSE, fig.retina=8, fig.cap=paste0(" Goals and targets of the Kunming-Montreal Global Biodiversity Framework that have a ",  tolower(terms[1]), ", ", tolower(terms[2]), ", or ", tolower(terms[3]), " ", tolower(term), " with ", nbtalt), fig.id="fig5", fig.cap.pre="Figure 2.", fig.lp="sec2"}
# Figure 2.4
ggplot(dtaa, aes(x = gbf_ttl, y = n, fill = cat)) +
  geom_bar(stat = "identity", colour = "black") +
  scale_x_discrete(guide = guide_axis(angle = 45)) + 
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(values = unname(cols[-4])) + 
  labs(x = "Global goals and targets", 
       y = paste0("Number of national targets with ", tolower(term), "\nto each of the global goals and targets"), 
       fill = term) +
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 8), axis.text = element_text(size = 7), 
        legend.title = element_text(face = "bold", size = 10), legend.text = element_text(size = 9), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_line(), panel.grid.major.x = element_blank()
        )
```

```{r tbl_aux, include = FALSE}
# builds table
## sub-sets the data, giving GBF Goals and Targets (rows), Low, Medium High (columns)
tbl <- dta %>% 
  select(nbt_ttl, gbf_ttl, cat) %>% 
  pivot_wider(names_from = cat, values_from = nbt_ttl) %>% 
  select(-termss)
tbl_dif <- setdiff(terms, colnames(tbl)[-1])
if (length(tbl_dif) >= 1){
  for (i in 1:length(tbl_dif)){
  tbl <- tbl %>% 
    mutate(cat = NA) %>% 
    rename(!!tbl_dif[i] := cat)
}
}

# ... column Low
if (is.null(select(tbl, terms[1]))){
  tbl_l <- data.frame("gbf_ttl" = character(), cat = character()) %>% 
    rename(!!terms[1] := cat)
} else {
tbl_l <- tbl %>% select(gbf_ttl, terms[1]) %>% unnest(terms[1]) %>% 
  group_by(gbf_ttl) %>% mutate(cat = toString(sort(unique(get(terms[1]))))) %>% 
  select(-2) %>% 
  rename(!!terms[1] := cat) %>% 
  unique()
}

# ... column Medium
if (is.null(select(tbl, terms[2]))){
  tbl_m <- data.frame("gbf_ttl" = character(), cat = character()) %>% 
    rename(!!terms[2] := cat)
} else {
tbl_m <- tbl %>% select(gbf_ttl, terms[2]) %>% unnest(terms[2]) %>% 
  group_by(gbf_ttl) %>% mutate(cat = toString(sort(unique(get(terms[2]))))) %>% 
  select(-2) %>% 
  rename(!!terms[2] := cat) %>% 
  unique()
}

# ... column High
if (is.null(select(tbl, terms[3]))){
  tbl_h <- data.frame("gbf_ttl" = character(), cat = character()) %>% 
    rename(!!terms[3] := cat)
} else {
tbl_h <- tbl %>% select(gbf_ttl, terms[3]) %>% unnest(terms[3]) %>% 
  group_by(gbf_ttl) %>% mutate(cat = toString(sort(unique(get(terms[3]))))) %>% 
  select(-2) %>% 
  rename(!!terms[3] := cat) %>% 
  unique()
} 

# ...joins the above
tbl <- tbl %>% select(gbf_ttl) %>% 
  left_join(tbl_h) %>% 
  left_join(tbl_m) %>% 
  left_join(tbl_l) %>% 
  rename("Global goal or target" = gbf_ttl)
tbl[is.na(tbl)] = ""
```

```{r clean8_l, echo=FALSE}
rm(tbl_l, tbl_m, tbl_h, tbl_dif)
```

<br>

```{r tbl, echo = FALSE, warning = FALSE, tab.cap=paste0(" Expanded overview of ", tolower(term), " between the goals and targets of the Kunming-Montreal Global Biodiversity Framework and the ", nbtalt), tab.id="tbl2", tab.cap.pre="Table 2.", tab.autonum.start_at=1, tab.lp="sec21"}
# creates Table
tbl %>% flextable(cwidth = c(1.2, 1.6, 1.6, 1.6)) %>% 
  bg(part = "header", j = c(1, 2, 3, 4), bg = append("black", rev(cols[-4]))) %>% 
  color(part = "header", i = 1, j = 1, color = "white") %>% # i = 2
  color(part = "header", i = 1, j = c(2, 3, 4), color = "black") %>% # i = 2
  align(part = "header", align = "center") %>% 
  bold(part = "header") %>% 
  bold(part = "body", j = 1) %>% 
  hline(part = "all")
```

```{r clean9, echo=FALSE}
rm(tbl)
```

\newpage

::: {custom-style="Heading 1"}
# Section 3: Similarity Analysis on the 4 Global Goals and 23 Targets {#sec3}
:::

###  {#sec31}

::: {custom-style="Text"}
This section provides a detailed analysis of `r fill0` in relation to each of the Kunming-Montreal Global Biodiversity Framework goals and targets. By examining the level of similarity, identifying gaps, and highlighting recommendations for enhancement, the assessment can offer valuable insights for improving the country's biodiversity strategies. It is recommended that countries manually review these results and, if helpful, use them to support stakeholder engagement processes for NBSAP alignment and update or revision.

The following guiding questions can be useful to consider when reviewing the results:

-   Which `r substr(nbtalt, 1, nchar(as.character(nbtalt))-1)`(s) appear(s) to be the most aligned to each global goal or target? Where do multiple `r nbtalt` support national action towards a global goal or target?

-   What elements of the Kunming-Montreal Global Biodiversity Framework, if any, are missing from the `r substr(nbtalt, 1, nchar(as.character(nbtalt))-1)`(s)?

-   How could the `r substr(nbtalt, 1, nchar(as.character(nbtalt))-1)`(s) be updated or revised to better align with the global goals and targets? Are new `r nbtalt` necessary?

-   What mechanisms should be in place to achieve the `r nbtalt` and how should they be represented in the NBSAP? This could include stakeholder engagement, finance, implementation, capacity building and development plans, and monitoring systems.
:::

```{r tbl_aux2, include = FALSE}
# arranges the count of similarity categories by GBF Goals or Targets
dtaa <- dtaa %>% as.data.frame() %>% arrange(gbf_ttl)

# sub-sets the data, giving a list of the similarity categories of each NBT and GBF Goal or Target
ddextra <- dta %>% 
  select(nbt_ttl, gbf_ttl, cat) %>% 
  filter(cat != termss)

names(cols) <- append(terms, "NBT")
```

```{r s3_aux, include=FALSE}
labs <- c(str_to_title(nbtalt), "Similarity score", "Similarity score") ### ENGLISH ###
labss <- c(str_to_title(nbtalt), "Text", "Assessment and recommendations") ### ENGLISH ###

# Adds layers to the base plots
if (params$country == "Uzbekistan" | params$country == "Pakistan" | 
    params$country == "Kazakhstan" | params$country == "South Africa" | 
    params$country == "Maldives" | params$country == "Kyrgyzstan" | 
    params$country == "Somalia") {
  lyr1 <- facet_wrap(~nbt_t, scales = "free_x", strip.position = "top")
  lyr2 <- scale_x_discrete(guide=guide_axis(n.dodge=2))
  lyr3 <- theme(strip.background = element_rect(fill = "black"), 
        strip.text = element_text(colour = "white"))}
if (params$country == "Guyana" | params$country == "Grenada" | 
    params$country == "Suriname") {
  lyr1 <- facet_grid(~nbt_t, scales = "free", space = "free")
  lyr2 <- scale_x_discrete(guide=guide_axis(n.dodge=2))
  lyr3 <- theme(strip.background = element_rect(fill = "black"), 
        strip.text = element_text(colour = "white"))}
if (params$country == "Nepal") {
  lyr1 <- facet_wrap(~nbt_t, nrow = 1, scales = "free_x", strip.position = "bottom")
  lyr2 <- scale_x_discrete(guide=guide_axis(n.dodge=2))
  lyr3 <- theme(strip.background = element_rect(fill = "black"), 
        strip.text = element_text(colour = "white"))}
if (params$country == "Lebanon" | params$country == "Laos") {
  lyr1 <- facet_wrap(~nbt_t, nrow = 2, scales = "free_x")
  lyr2 <- scale_x_discrete(guide=guide_axis(n.dodge=2)) 
  lyr3 <- theme(strip.background = element_rect(fill = "black"), 
                axis.text.x = element_text(angle = 90, vjust = 0.4), 
        strip.text = element_text(colour = "white", size = 7), )}
```

\newpage

```{r txt_aux3, include=FALSE}
extra <- "Goal A" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig6)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl3)"))` `r headache3`
:::

```{r plot5, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig6", fig.cap.pre="Figure 3.", fig.autonum.start_at=1, fig.lp="sec3"}
# if no similarities, don't create (Figure 3.1)
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl3, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl3", tab.cap.pre="Table 3.", tab.autonum.start_at=1, tab.lp="sec31"}
# if no similarities, don't create (Table 3.1)
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

# technicality regarding the table (Table 3.1)
ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}}

# technicality regarding the table (Table 3.1)
for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

# Table 3.1
tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux4, include=FALSE}
extra <- "Goal B" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig7)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl4)"))` `r headache3`
:::

```{r plot6, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig7", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl4, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl4", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
    arrange(desc(llm_scr)) %>% 
    select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
    filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
  for (i in 2:length(ref)){
    ref[i] <- ref[i] + (i-1)
  }  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux5, include=FALSE}
extra <- "Goal C" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig8)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl5)"))` `r headache3`
:::

```{r plot7, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig8", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl5, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl5", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux6, include=FALSE}
extra <- "Goal D" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig9)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl6)"))` `r headache3`
:::

```{r plot8, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig9", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl6, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl6", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux7, include=FALSE}
extra <- "Target 1" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig10)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl7)"))` `r headache3`
:::

```{r plot9, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig10", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl7, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl7", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux8, include=FALSE}
extra <- "Target 2" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig11)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl8)"))` `r headache3`
:::

```{r plot10, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig11", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl8, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl8", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux9, include=FALSE}
extra <- "Target 3" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig12)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl9)"))` `r headache3`
:::

```{r plot11, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig12", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl9, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl9", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux10, include=FALSE}
extra <- "Target 4" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig13)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl10)"))` `r headache3`
:::

```{r plot12, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig13", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl10, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl10", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux11, include=FALSE}
extra <- "Target 5" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig14)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl11)"))` `r headache3`
:::

```{r plot13, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig14", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl11, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl11", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux12, include=FALSE}
extra <- "Target 6" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig15)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl12)"))` `r headache3`
:::

```{r plot14, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig15", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl12, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl12", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux13, include=FALSE}
extra <- "Target 7" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig16)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl13)"))` `r headache3`
:::

```{r plot15, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig16", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl13, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl13", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux14, include=FALSE}
extra <- "Target 8" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig17)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl14)"))` `r headache3`
:::

```{r plot16, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig17", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl14, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl14", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux15, include=FALSE}
extra <- "Target 9" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig18)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl15)"))` `r headache3`
:::

```{r plot17, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig18", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl15, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl15", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux16, include=FALSE}
extra <- "Target 10" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig19)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl16)"))` `r headache3`
:::

```{r plot18, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig19", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl16, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl16", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux17, include=FALSE}
extra <- "Target 11" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig20)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl17)"))` `r headache3`
:::

```{r plot19, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig20", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl17, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl17", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux18, include=FALSE}
extra <- "Target 12" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig21)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl18)"))` `r headache3`
:::

```{r plo20, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig21", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl18, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl18", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux19, include=FALSE}
extra <- "Target 13" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig22)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl19)"))` `r headache3`
:::

```{r plo21, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig22", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl19, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl19", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux20, include=FALSE}
extra <- "Target 14" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig23)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl20)"))` `r headache3`
:::

```{r plo22, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig23", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl20, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl20", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux21, include=FALSE}
extra <- "Target 15" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig24)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl21)"))` `r headache3`
:::

```{r plo23, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig24", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl21, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl21", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux22, include=FALSE}
extra <- "Target 16" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig25)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl22)"))` `r headache3`
:::

```{r plo24, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig25", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl22, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl22", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux23, include=FALSE}
extra <- "Target 17" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig26)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl23)"))` `r headache3`
:::

```{r plo25, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig26", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl23, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl23", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux24, include=FALSE}
extra <- "Target 18" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig27)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl24)"))` `r headache3`
:::

```{r plo26, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig27", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl24, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl24", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux25, include=FALSE}
extra <- "Target 19" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig28)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl25)"))` `r headache3`
:::

```{r plo27, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig28", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl25, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl25", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux26, include=FALSE}
extra <- "Target 20" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig29)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl26)"))` `r headache3`
:::

```{r plo28, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig29", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl26, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl26", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux27, include=FALSE}
extra <- "Target 21" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig30)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl27)"))` `r headache3`
:::

```{r plo29, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig30", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl27, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl27", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux28, include=FALSE}
extra <- "Target 22" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig31)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl28)"))` `r headache3`
:::

```{r plo30, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig31", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl28, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE,  tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl28", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

\newpage

```{r txt_aux29, include=FALSE}
extra <- "Target 23" # Change for each sub-section in Section 3

# sub-set the data, giving count of NBTs with similarity per similarity category for "extra" GBF Goal or Target (Figure 3.1)
dextra <- dtaa %>% 
  filter(gbf_ttl == extra) %>% 
  mutate(tgt = ifelse(n == 1, 
                      substr(str_extract(nbtalt, "\\w+$"), 1, nchar(as.character(str_extract(nbtalt, "\\w+$")))-1), 
                      str_extract(nbtalt, "\\w+$"))) ### ENGLISH ###

# creates a condition that blocks the creation of figures and tables in case there are no similarities (for text)
condition <- (filter(dextra, cat == terms[3])[3] == 0) & (filter(dextra, cat == terms[2])[3] == 0) & (filter(dextra, cat == terms[1])[3] == 0)

# sub-set of the data, just "extra"GBF Goal or Target (sub-set of ddextra)
ddextraa <- ddextra %>% 
  filter(gbf_ttl == extra)

# isolates the "extra" GBF Goal otr Target's text/description
gbf_txt <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% 
  filter(gbf_ttl == extra) %>% 
  rename(gbf_txt = txt_en)

# creates condition-based text (for text)
if(condition == TRUE){
  headache1 <- paste0("Upon request, assessments from the model can be provided on how to better align specific ", nbtalt, " to this global ", tolower(sub(" .*", "", extra)), ".") ### ENGLISH ###
  headache2 <- ""; headache3 <- ""
} else {
  headache1 <- "Figure " ### ENGLISH ###
  headache2 <- paste0(" shows the similarity scores produced when comparing the ", nbtalt, " to ", extra, ". Table ") ### ENGLISH ###
  headache3 <- paste0(" identifies the ", nbtalt, " with some similarity and provides enhancement recommendations.") ### ENGLISH ###
}
```

::: {custom-style="Heading 2"}
## Kunming-Montreal Global Biodiversity Framework `r extra`
:::

<br>

::: {custom-style="Text"}
`r extra` of the Kunming-Montreal Global Biodiversity Framework states:
:::

::: {custom-style="Citation"}
`r gbf_txt$gbf_txt`
:::

::: {custom-style="Text"}
*Similarity between `r fill0` and `r extra`*

`r params$country` has `r dextra$n[3]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[3]` with a `r tolower(terms[3])` `r tolower(term)` with `r extra`, `r dextra$n[2]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[2]` with a `r tolower(terms[2])` `r tolower(term)`, and `r dextra$n[1]` `r str_pad(str_remove(nbtalt, "\\s*\\w+$"), width = nchar(str_remove(nbtalt, "\\s*\\w+$"))+1, side = "right")``r dextra$tgt[1]` with `r tolower(terms[1])` `r tolower(term)`. `r headache1` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(fig:fig32)"))` `r headache2` `r ifelse(condition == TRUE, "", paste0("**3.**\\@ref(tab:tbl29)"))` `r headache3`
:::

```{r plo31, fig.height=3.3, fig.align="center", echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, results = "hide", fig.retina=8, fig.cap=paste0(term, " score of all ", nbtalt, " in relation to ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), fig.id="fig32", fig.cap.pre="Figure 3.", fig.lp="sec3"}
if(condition == TRUE){
  NULL
} else {
  dga <- dta %>% 
    filter(gbf_ttl == extra)

plot <- ggplot(dga, aes(x = nbt_n, y = as.numeric(llm_scr), fill = cat)) + 
  geom_bar(stat = "identity", colour = "black") +
  scale_y_continuous(expand = c(0, 0)) + 
  scale_fill_manual(name = "Similarity", values = cols, drop = FALSE) + 
  coord_cartesian(ylim = c(0, 1)) +
  labs(x = labs[1], y = labs[2], fill = labs[3]) + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5, size = 8), 
        axis.title = element_text(face = "bold", size = 7), axis.text = element_text(size = 6), 
        legend.title = element_text(face = "bold", size = 7), legend.text = element_text(size = 6), 
        legend.position = "bottom", 
        panel.background = element_blank(), 
        panel.grid.major.y = element_blank(), panel.grid.major.x = element_blank()
        )
if (cond == 1) {
  plot <- plot + lyr1 + lyr2 + lyr3
}

plot
}
```

`r if(condition == FALSE){run_pagebreak()}`

```{r tbl29, echo = FALSE, warning = FALSE, message = FALSE, error = FALSE, tab.cap=paste0(str_to_title(nbtalt), " with ", tolower(terms[3]), " to ", tolower(terms[1]), " ", tolower(term), " with ", extra, " of the Kunming-Montreal Global Biodiversity Framework"), tab.id="tbl29", tab.cap.pre="Table 3.", tab.lp="sec31"}
if(condition == TRUE){
  cat(" ")
} else {
  tgbf <- dga %>% 
  arrange(desc(llm_scr)) %>% 
  select(nbt_ttl, nbt_txt, llm_dscr, cat) %>% 
  filter(cat != termss)

ref <- match(unique(tgbf$cat), tgbf$cat)
if (length(ref) > 1){
for (i in 2:length(ref)){
  ref[i] <- ref[i] + (i-1)
}  
}

for (i in 1:length(ref)){
  tgbf <- tgbf %>% 
    add_row(nbt_ttl = tgbf$cat[ref[i]], .before = ref[i])
}
tgbf$cat <- as.character(tgbf$cat)
tgbf <- tgbf %>% 
  select(-cat)
tgbf[is.na(tgbf)] <- ""
colnames(tgbf) <- labss

tbl <- tgbf %>% flextable(cwidth = c(0.8, 2, 3.2)) %>% 
    bold(part = "header") %>% italic(part = "body", j = 2) %>% 
    valign(valign = "top") %>% 
    align(align = "justify")
  for (i in 1:length(ref)){
    tbl <- tbl %>% 
      bg(part = "body", i = ref[i], bg = if(tgbf[ref[i], 1] == terms[1]){cols[1]} 
         else if (tgbf[ref[i], 1] == terms[2]){cols[2]} 
         else if(tgbf[ref[i], 1] == terms[3]){cols[3]}) %>% 
      color(part = "body", i = ref[i], color = "black")
}
tbl
}
```

```{r clean9_l, include=FALSE}
rm(extra, dextra, ddextra, condition, ddextraa, gbf_txt, headache1, headache2, headache3, dga, tgbf, ref, tbl, termss, terms)
```

\newpage

::: {custom-style="Heading 1"}
# Appendix 1: `r str_to_title(fill0)`
:::

```{r tbl_nbt, echo=FALSE, warning=FALSE, tab.cap=""}
# sub-sets the data, isolating the NBTs
nbt_df <- dta %>% 
  select(nbt_title, nbt_ttl, nbt_txt, nbt_n) %>% 
  unique() %>% 
  #arrange(nbt_n) %>% 
  select(-nbt_n) %>% 
  mutate(nbt_ttl = ifelse(nbt_ttl == nbt_title, nbt_title, paste0(nbt_title, " (", nbt_ttl, ")"))) %>% 
  select(-nbt_title) %>% 
  add_row(nbt_ttl = str_to_title(nbtalt), ### ENGLISH ###
          nbt_txt = "", .before = 1)

# Appendix 1 table
nbt_df %>% flextable(cwidth = c(0.8, 5.2)) %>% 
  delete_part(part = "header") %>% 
  merge_at(i = 1, j = c(1, 2), part = "body") %>% 
  bg(part = "body", i = 1, bg = "#00A54A") %>% 
  color(part = "body", i = 1, color = "white") %>% 
  bold(part = "body", i = 1) %>% 
  italic(part = "body", j = 2) %>% 
  bold(part = "body", j = 1) %>% 
  valign(valign = "top") %>% 
  align(part = "body", align = "justify")

```

\newpage

::: {custom-style="Heading 1"}
# Appendix 2: Goals and Targets of the Kunming-Montreal Global Biodiversity Framework
:::

```{r tbl_gbf, echo = FALSE, warning=FALSE, tab.cap=""}
# sub-sets the data, isolating the GBF Goals or Targets
gbf_df <- gbf_tr %>% 
  select(gbf_ttl, txt_en) %>% ### ENGLISH ###
  unique() %>% 
  rename(gbf_txt = txt_en) %>% ### ENGLISH ###
  mutate(gbf_txt = trimws(gbf_txt)) %>% 
  add_row(gbf_ttl = "Global Goals: Kunming-Montreal Global Biodiversity Framework", 
          gbf_txt = "", .before = 1) %>% 
  add_row(gbf_ttl = "Global Targets: Kunming-Montreal Global Biodiversity Framework", 
          gbf_txt = "", .before = 6)

# Appendix 2 table
gbf_df %>% flextable(cwidth = c(0.6, 5.4)) %>% 
  delete_part(part = "header") %>% 
  merge_at(i = 1, j = c(1, 2), part = "body") %>% 
  bg(part = "body", i = 1, bg = "#00A54A") %>% 
  color(part = "body", i = 1, color = "white") %>% 
  bold(part = "body", i = 1) %>% 
  merge_at(i = 6, j = c(1, 2), part = "body") %>% 
  bg(part = "body", i = 6, bg = "#00A54A") %>% 
  color(part = "body", i = 6, color = "white") %>% 
  bold(part = "body", i = 6) %>% 
  italic(part = "body", j = 2) %>% 
  bold(part = "body", j = 1) %>% 
  valign(valign = "top") %>% 
  align(part = "body", align = "justify")

```

\newpage

::: {custom-style="Heading 1"}
# Appendix 3: Methodology
:::

<br>

::: {custom-style="Text"}
**Methods** This section outlines the methodology employed by the UNDP GEF EAS Project team to use natural language processing techniques and artificial intelligence to assess the degree of similarity between national biodiversity targets and the global goals and targets defined within the Kunming-Montreal Global Biodiversity Framework.

**Data Sources** Two primary open-source text sources were utilized for the assessment:

```{r}
fill5 <- ifelse(params$country == TRUE, 'the CBD "[Find Targets](https://www.cbd.int/nbsap/targets/)" webpage', 'publicly available documentation submitted by the partner country')
```

-   National Biodiversity Targets: These were obtained from `r fill5`.

-   Global Goals and Targets: These were extracted from the [Kunming-Montreal Global Biodiversity Framework (CBD COP Decision 15/4](https://www.cbd.int/doc/decisions/cop-15/cop-15-dec-04-en.pdf).

**Phase 1: Global to National Target Similarity Scoring** UNDP initially aimed to compute the similarity between national biodiversity targets and keywords from the global goals and targets using the Bidirectional Encoder Representations from Transformers (BERT) model to assess cosine similarity. BERT takes into account word synonyms and context, making it suitable for this analysis. Although Term Frequency - Inverse Document Frequency (TF-IDF) was considered, it was deemed less suitable due to its deprioritization of frequent words.

**Phase 2: Thematic Similarity Scoring** The assessment extended to consider thematic similarity between national biodiversity targets and specific sub-categories or “themes” within each global goal or target. Themes were identified based on the [CBD 2030 Target and Guidance Notes](https://www.cbd.int/gbf/targets/), and keywords associated with each theme were used for comparison. Natural language processing techniques were applied to assess this thematic similarity using the BERT model.

**Phase 3: Consideration of Large-Language Models (LLMs)** The application of OpenAI’s Generative Pre-trained Transformer (GPT 3.5) was then explored to assess similarity between the national biodiversity targets and the global goals and targets. GPT 3.5 offers the advantage of a deeper understanding of text context and nuances as well as the ability to provide recommendations in paragraph form. This feature can be particularly useful for identifying areas of similarity and potential gaps between the national and global targets.

**Phase 4: Model Selection and Validation** A rigorous validation process was conducted comparing GPT3.5 and BERT. Results indicated that GPT 3.5 produced more accurate assessments of similarity due to its improved text understanding capabilities. While BERT often overestimated similarity based on shared keywords, GPT 3.5 provided a nuanced evaluation of target alignment and was therefore selected to run the analysis.

**Next Steps and Further Investigation** A peer review process is being undertaken to validate the accuracy and utility of the NBSAP target similarity assessments with select CBD Parties that are supported by the project, the Secretariat to the Convention on Biological Diversity, and the UNDP Chief Digital Office. Feedback from countries will inform iterative advances to the assessment methodology, visualizations, and information presentation. Furthermore, a global report on trends in national biodiversity target similarity is planned using this same methodology, which will serve as a baseline for tracking alignment changes over time.
:::

```{r formating4, include=FALSE}
# portrait orientation, hitherto
block_section(sec_port)
```
